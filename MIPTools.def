Bootstrap: docker
From: amd64/ubuntu:20.04

##################################################################
##                        Labels Section                        ##
##################################################################
%labels
    Author Bailey Lab
    Version v0.4.0.9000

##################################################################
##                         Post Section                         ##
##################################################################
%post
    # set number of cpus to use in build
    CPU_COUNT=20

    # set build environment
    export DEBIAN_FRONTEND=noninteractive \
        SHELL=/bin/bash \
        LANG=en_US.UTF-8 \
        LANGUAGE=en_US.UTF-8 \
        LC_ALL=en_US.UTF-8

    # install system packages
    apt-get update \
    && apt-get -yq dist-upgrade \
    && apt-get install -yq --no-install-recommends \
    wget \
    bzip2 \
    ca-certificates \
    sudo \
    locales \
    fonts-liberation \
    fonts-dejavu \
    git \
    build-essential \
    gcc \
    openssh-client \
    nano \
    libtbb-dev \
    libz-dev \
    libxrender1 \
    cmake \
    automake \
    autoconf \
    rsync \
    pigz \
    perl-tk \
    less \
    software-properties-common \
    libxext6 \
    libxrender1 \
    ghostscript \
    openjdk-11-jdk \
    liblzma-dev \
    libbz2-dev \
    libssl-dev \
    libcurl4-gnutls-dev \
    alien \
    unzip \
    tree \
    pandoc

    # set environment locale
    echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
    echo "LANG=en_US.UTF-8" > /etc/locale.conf
    echo "LC_ALL=en_US.UTF-8" >> /etc/environment
    echo "LANGUAGE=en_US.UTF-8" >> /etc/environment
    locale-gen en_US.UTF-8
    update-locale LANG=en_US.UTF-8

    # install bcl2fastq, if the file is there
    cd /opt/programs
    unzip bcl2fastq2*.zip || true
    alien bcl2fastq2*.rpm || true
    dpkg -i bcl2fastq2*.deb || true

    # install msa2vcf
    cd /opt/programs
    git clone --branch 2021.10.13 https://github.com/lindenb/jvarkit.git
    cd jvarkit
    ./gradlew msa2vcf

    # install conda and python via Miniconda3
    PYTHON_VERSION=3.8
    MINICONDA_VERSION=4.8.3
    MINICONDA_MD5=d63adf39f2c220950a063e0529d4ff74
    CONDA_DIR=/opt/conda
    export PATH=${CONDA_DIR}/bin:${PATH}
    cd /tmp && \
        wget --quiet "https://repo.anaconda.com/miniconda/Miniconda3-py${PYTHON_VERSION//./}_${MINICONDA_VERSION}-Linux-x86_64.sh" && \
        echo "${MINICONDA_MD5} *Miniconda3-py${PYTHON_VERSION//./}_${MINICONDA_VERSION}-Linux-x86_64.sh" | md5sum -c - && \
        /bin/bash Miniconda3-py${PYTHON_VERSION//./}_${MINICONDA_VERSION}-Linux-x86_64.sh -bfp ${CONDA_DIR} && \
        rm Miniconda3-py${PYTHON_VERSION//./}_${MINICONDA_VERSION}-Linux-x86_64.sh && \
        ${CONDA_DIR}/bin/conda config --add channels defaults && \
        ${CONDA_DIR}/bin/conda config --add channels bioconda && \
        ${CONDA_DIR}/bin/conda config --add channels conda-forge && \
        ${CONDA_DIR}/bin/conda config --add channels r && \
        ${CONDA_DIR}/bin/conda config --system --set show_channel_urls true && \
        ${CONDA_DIR}/bin/conda install --quiet --yes conda="${MINICONDA_VERSION%.*}.*" && \
        conda clean --all -f -y

    # install mamba
    conda install mamba=0.13.0 -c conda-forge

    # install conda packages using mamba
    mamba install -qy\
      "r=3.6.3" \
      "r-epitools=0.5_10" \
      "rpy2=3.4.4" \
      "r-irkernel=1.2" \
      "r-plotly=4.9.3" \
      "r-knitr=1.33" \
      "r-shiny=1.6.0" \
      "r-ggplot2=3.3.3" \
      "r-devtools=2.4.1" \
      "r-dplyr=1.0.6" \
      "r-dt=0.18" \
      "r-pkgbuild=1.2.0" \
      "gxx_linux-64=7.5.0" \
      "python=3.8.3" \
      "notebook=6.4.0" \
      "nbconvert=6.0.7" \
      "jupyter_contrib_nbextensions=0.4.1" \
      "xlrd=2.0.1" \
      "bcftools=1.12" \
      "samtools=1.12" \
      "vcftools=0.1.16" \
      "htslib=1.12" \
      "bwa=0.7.17" \
      "bowtie2=2.4.3" \
      "primer3=2.5.0" \
      "primer3-py=0.6.0" \
      "numpy=1.20.3" \
      "scipy=1.6.2" \
      "biopython=1.78" \
      "pysam=0.16.0.1" \
      "pandas=1.2.4" \
      "matplotlib=3.4.2" \
      "seaborn=0.11.1" \
      "scikit-learn=0.24.2" \
      "scandir=1.10.0" \
      "openpyxl=3.0.7" \
      "simplegeneric=0.8.1" \
      "matplotlib-venn=0.11.6" \
      "tblib=1.7.0" \
      "parallel=20210422" \
      "scikit-allel=1.3.5" \
      "bioconductor-dnacopy=1.60.0" \
      "basemap-data-hires=1.2.2" \
      "seqtk=1.3" \
      "gatk4=4.2.0.0" \
      "freebayes=1.3.6" \
      "lastz=1.0.4" \
      "plotly=4.14.3" \
      "texlive-core=20180414" \
      "libgfortran4=7.5.0"

    # install vt variant tool set
    cd /opt/programs
    git clone --branch 0.577 https://github.com/atks/vt.git
    cd vt
    make -j $CPU_COUNT
    scp vt /opt/bin

    # install magrittr
    Rscript -e 'devtools::install_version(
        package = "magrittr",
        version = "2.0.2",
        repos = "https://cloud.r-project.org"
    )'

    # install RealMcCoil
    Rscript -e 'devtools::install_github("OJWatson/McCOILR", ref = "v1.3.1")'

    # install rehh
    Rscript -e 'devtools::install_version(
        package = "rehh", 
        version = "3.2.2",
        repos = "https://cloud.r-project.org"
    )'

    # install MIPWrangler
    cd /opt/programs
    git clone --branch v1.2.0 https://github.com/bailey-lab/MIPWrangler
    cd MIPWrangler
    ./install.sh $CPU_COUNT

    # install elucidator
    cd /opt/programs
    git clone --branch develop https://github.com/nickjhathaway/elucidator
    cd elucidator
    ./install.sh $CPU_COUNT

    # install parasight
    scp /opt/programs/parasight_v7.6/parasight.pl /opt/bin/parasight76.pl

    # install basespace cli
    BS_VERSION=1.5.1
    BS_PATH="https://launch.basespace.illumina.com/CLI/${BS_VERSION}/amd64-linux/bs"
    wget $BS_PATH -O /opt/bin/bs

    # add executable flag to executables
    chmod -R +xr /usr/bin
    chmod -R +xr /opt/bin

    # create work and resources directories in /opt
    mkdir /opt/work \
        /opt/project_resources \
        /opt/species_resources \
        /opt/data \
        /opt/analysis \
        /opt/host_species \
        /opt/extras

#################################################################
##                        Files Section                        ##
#################################################################
%files
    programs /opt
    bin /opt
    src /opt
    base_resources/ /opt/resources

#################################################################
##                     Environment Section                     ##
#################################################################
%environment
    path=/opt/bin:/opt/conda/bin:/opt/programs/MIPWrangler/bin:
    path=$path/opt/programs/elucidator/bin:/opt/programs/gatk:
    path=$path$PATH
    export PATH=$path
    export XDG_RUNTIME_DIR=""
    export DEBIAN_FRONTEND=noninteractive
    export LANG=en_US.UTF-8
    export LANGUAGE="en_US.UTF-8"
    export LC_ALL="en_US.UTF-8"
